version: "3.4"

services:
  static-server:
    build:
      context: .
      dockerfile: static-server.Dockerfile
    volumes:
      - ./remote:/app/remote
    ports:
      - 5551:5551
  # ssh
  ssh:
    image: lscr.io/linuxserver/openssh-server:latest
    environment:
      - PASSWORD_ACCESS=true
      - USER_PASSWORD=pass
      - USER_NAME=u
      - DOCKER_MODS=linuxserver/mods:openssh-server-ssh-tunnel
      - PUBLIC_KEY_DIR=/keys/pub
    volumes:
      - ./rte/ssh/keys:/keys
    ports:
      - 2222:2222
    networks:
      default:
        ipv4_address: 172.31.100.245
      ssh:
        ipv4_address: 172.33.100.245

  # oss standalone
  oss-standalone:
    image: redislabs/redismod
    command: [
        "--loadmodule", "/usr/lib/redis/modules/redisearch.so",
        "--loadmodule", "/usr/lib/redis/modules/redisgraph.so",
        "--loadmodule", "/usr/lib/redis/modules/redistimeseries.so",
        "--loadmodule", "/usr/lib/redis/modules/rejson.so",
        "--loadmodule", "/usr/lib/redis/modules/redisbloom.so"
    ]
    ports:
      - 8100:6379

  oss-standalone-empty:
    image: redislabs/redismod
    command: [
      "--loadmodule", "/usr/lib/redis/modules/redisearch.so",
      "--loadmodule", "/usr/lib/redis/modules/redisgraph.so",
      "--loadmodule", "/usr/lib/redis/modules/redistimeseries.so",
      "--loadmodule", "/usr/lib/redis/modules/rejson.so",
      "--loadmodule", "/usr/lib/redis/modules/redisbloom.so"
    ]
    ports:
      - 8105:6379

  # oss standalone v5
  oss-standalone-v5:
    image: redis:5
    ports:
      - 8101:6379
    networks:
      default:
        ipv4_address: 172.31.100.111
      ssh:
        ipv4_address: 172.33.100.111
  # oss standalone redisearch
  oss-standalone-redisearch:
    image: redislabs/redismod
    ports:
      - 8102:6379
  
  oss-standalone-redisgears-2-0:
    image: redislabs/redisgears:edge
    ports:
      - 8106:6379

  oss-standalone-big:
    build:
      context: ./rte/oss-standalone-big
      dockerfile: Dockerfile
      args:
        TEST_DB_DUMP: $TEST_BIG_DB_DUMP
    ports:
      - 8103:6379

  # oss standalone tls
  oss-standalone-tls:
    build:
      context: ./rte/oss-standalone-tls
      dockerfile: Dockerfile
    ports:
      - 8104:6379

  # oss sentinel
  oss-sentinel:
    build: ./rte/oss-sentinel
    depends_on:
      - oss-sentinel-primary-1
      - oss-sentinel-primary-2
    ports:
      - 28100:26379

  oss-sentinel-primary-1:
    image: redis:5

  oss-sentinel-primary-2:
    image: redis:5

  # oss cluster (v7)
  cluster-plain-creator-7:
    build:
      context: ./rte/oss-cluster-7
      dockerfile: creator.Dockerfile
    depends_on:
      - master-plain-7-1
      - master-plain-7-2
      - master-plain-7-3
  master-plain-7-1:
    build: &cluster-plain-7-build ./rte/oss-cluster-7
    ports:
      - 8200:6379
    networks:
      default:
        ipv4_address: 172.31.100.211
  master-plain-7-2:
    build: *cluster-plain-7-build
    networks:
      default:
        ipv4_address: 172.31.100.212
  master-plain-7-3:
    build: *cluster-plain-7-build
    networks:
      default:
        ipv4_address: 172.31.100.213

  # oss cluster (v7) with rediserch > 2.2
  cluster-rs-creator-7:
    build:
      context: &cluster-rs-7-build ./rte/oss-cluster-7-rs
      dockerfile: creator.Dockerfile
    depends_on:
      - master-rs-7-1
      - master-rs-7-2
      - master-rs-7-3
  master-rs-7-1:
    build: *cluster-rs-7-build
    ports:
      - 8221:6379
    networks:
      default:
        ipv4_address: 172.31.100.221
  master-rs-7-2:
    build: *cluster-rs-7-build
    networks:
      default:
        ipv4_address: 172.31.100.222
  master-rs-7-3:
    build: *cluster-rs-7-build
    networks:
      default:
        ipv4_address: 172.31.100.223

  #oss cluster with redisgears 2
  oss-cluster-redisgears-2-0:
    image: redislabs/redisgears:edge
    ports:
      - 8107:6379
  gears-cluster-2-0:
    image: redis:latest

    command: redis-cli -p 7001 --cluster create 10.0.0.11:7001 10.0.0.12:7002 10.0.0.13:7003 10.0.0.14:7004 10.0.0.15:7005 10.0.0.16:7006 --cluster-replicas 1 --cluster-yes
    depends_on:
      - redis1
      - redis2
      - redis3
      - redis4
      - redis5
      - redis6
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.2

  redis1:
    image: redislabs/redisgears:edge
    ports:
      - 7001:7001
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7001.log --port 7001 --cluster-enabled yes
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.11
  redis2:
    image: redislabs/redisgears:edge
    ports:
      - 7002:7002
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7002.log --port 7002 --cluster-enabled yes
    depends_on:
      - redis1
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.12

  redis3:
    image: redislabs/redisgears:edge
    ports:
      - 7003:7003
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7003.log --port 7003 --cluster-enabled yes
    depends_on:
      - redis2
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.13

  redis4:
    image: redislabs/redisgears:edge
    ports:
      - 7004:7004
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7004.log --port 7004 --cluster-enabled yes
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.14

  redis5:
    image: redislabs/redisgears:edge
    ports:
      - 7005:7005
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7005.log --port 7005 --cluster-enabled yes
    depends_on:
      - redis1
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.15

  redis6:
    image: redislabs/redisgears:edge
    ports:
      - 7006:7006
    command: redis-server --protected-mode no --loadmodule /build/target/release/libredisgears.so v8-plugin-path /build/target/release/libredisgears_v8_plugin.so --logfile /build/7006.log --port 7006 --cluster-enabled yes
    depends_on:
      - redis2
    networks:
      redisclusternet:
        ipv4_address: 10.0.0.16

  # redis enterprise
  redis-enterprise:
    build: ./rte/redis-enterprise
    cap_add:
      - sys_resource
    ports:
      - 19443:9443
      - 12000:12000
networks:
  default:
    name: "e2e-private-network"
    ipam:
      driver: default
      config:
        - subnet: 172.31.100.0/24
          gateway: 172.31.100.1
  ssh:
    name: "e2e-ssh-network"
    ipam:
      driver: default
      config:
        - subnet: 172.33.100.0/24
          gateway: 172.33.100.1
  redisclusternet:
    name: redis
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/16
